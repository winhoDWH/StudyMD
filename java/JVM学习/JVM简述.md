### JVM简述

#### java类加载过程

1. 编写好的代码都是会生成`.java`源文件，通过编译器编译成`.class`字节码文件

；然后JVM通过自己的`字节码执行引擎`去执行加载到内存里面写好的类；

2. 执行加载的过程具体为：

   > 加载 -> 验证 -> 准备 -> 解析 -> 初始化 -> 使用 -> 卸载

3. `类加载的时机`：类在程序被调用的时候；
4. `验证阶段`：校验`.class`文件是否符合JVM的规范；
5. `准备阶段`：给类分配一定内存空间，并对`类变量`赋初始值，如整型为0;
6. `解析阶段`：将符号引用替换成直接引用（涉及JVM底层，可跳过）
7. `初始化阶段`：对`类变量`进行初始化操作，即执行代码中对`类变量`进行的赋值操作；**与准备阶段的初始值不同，初始值只是赋予JVM对各种类型的默认值（缺省值），初始化是执行我们代码中的赋值操作**；
8. **<u>初始化一个类</u>**之前如果发现该类的`父类`没有被加载和初始化，则会先加载父类；

#### 类加载器和双亲委派机制

1. java类的加载都是通过类加载器实现的，加载器的主要种类有：

   ![image-20210831204554408](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210831204554408.png)

2. `启动类加载器`（**Bootstrap ClassLoader**）：负责加载JDK的`lib`包下的核心类库；

3. `扩展类加载器`（**Extension ClassLoader**）：负责加载JDK的`lib\ext`目录中的类，去支撑系统的运行；

4. `应用程序类加载器`（**Application ClassLoader**）：加载`ClassPath`环境变量指定的类，即自定义编写好的java类；

5. `自定义类加载器`：自己根据需求可自定义类加载器；

6. `双亲委派机制`：当要加载一个类时，应用程序类加载器会将该类委派给**自己的父类加载器去加载**，直至到顶层（启动类加载器）加载，如果该类不在父类加载器的范围内，会交回给子类加载器去加载；即**<u>先将类向上扔（父类加载），再向下丢（交回给子类加载）</u>**

#### JVM存储划分（简要说明）

1. `方法区`：存放加载类之后产生的类信息，JDK1.8之后改成叫`Metaspace`，元数据空间，还是主要存加载之后的类信息；

2. `程序计数器`：字节码实际上就是机器指令，字节码文件就是写着有编号顺序的机器指令，程序计数器就是`字节码执行引擎`用来记录代码执行时对应的编号（<u>即当前执行的指令的位置</u>）

   ``` java
   //字节码大致模样，编号: 机器指令
   0: aload_0
   1: get_field
       .....
   ```

3. `java虚拟机栈`：用来记录和保存每个方法里面的局部变量等数据；<u>每个线程都有自己的java虚拟机栈</u>；

   * 栈帧：每执行一个方法都会生成一个栈帧（存放局部变量等方法信息）放入到`java虚拟机栈`中

4. `java堆内存`：每个<u>实例化的类对象</u>会存放在java堆内存，然后栈帧中的引用变量指向对应的实例；

   ![image-20210831211721844](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210831211721844.png)

#### 小知识扩展：

1. 如果不想别人通过根据`.class`文件反编译获取代码源码，可以先通过专业的字节码加密程序**加密.class文件**，通过**自定义加载器解密字节码后加载类**；

2. `tomcat这种web容器`的类加载

   ![image-20210831205823272](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210831205823272.png)

   然后Tomcat为每个部署在里面的Web应用配置对应的`WebApp类加载器`，负责加载我们部署的Web应用的类；`Jsp类加载器`就是加载JSP页面；

   **<u>Tomcat打破了双亲委派机制！！！</u>**每个`WebApp`负责加载自己对应的Web应用，即我们打包好的`war`包里面的`class`文件；

3. ![image-20210831211746525](C:\Users\lenovo\AppData\Roaming\Typora\typora-user-images\image-20210831211746525.png)